<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather Brief</title>
<style>
    body{background-color:#fff!important;color:#1A1A1A!important;margin:0;padding:0}
    .bg-r{background:linear-gradient(135deg,rgb(217,33,33) 0%,rgb(217,33,33) 100%)!important;background-color:rgb(217,33,33)!important}
    .bg-b{background:linear-gradient(135deg,rgb(27,75,154) 0%,rgb(27,75,154) 100%)!important;background-color:rgb(27,75,154)!important}
    .bg-y{background:linear-gradient(135deg,rgb(247,213,0) 0%,rgb(247,213,0) 100%)!important;background-color:rgb(247,213,0)!important}
    .bg-k{background-color:#1A1A1A!important}
    table{background-color:transparent!important}
    #ld{position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .4s;font-family:'Helvetica Neue',Helvetica,Arial,sans-serif}
    #ld.h{opacity:0;pointer-events:none}
    @keyframes cyc{0%,100%{background:rgb(217,33,33)}33%{background:rgb(247,213,0)}66%{background:rgb(27,75,154)}}
</style>
</head>
<body>
<div id="ld">
<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="width:620px;max-width:calc(100% - 30px)">
<tr>
<td id="ldac" width="6" style="background:rgb(217,33,33);border:3px solid #1A1A1A;border-right:none;animation:cyc 3s ease-in-out infinite"></td>
<td style="background:#fff;border:3px solid #1A1A1A;padding:28px 30px">
<table role="presentation" cellpadding="0" cellspacing="0" border="0"><tr><td style="background:#1A1A1A;padding:4px 10px"><span style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;font-size:10px;font-weight:bold;color:#fff;text-transform:uppercase;letter-spacing:1.5px">Weather Brief</span></td></tr></table>
<div id="ldtxt" style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;font-size:14px;color:#1A1A1A;padding-top:14px;line-height:1.6">Please allow location access to generate your weather report.</div>
<div id="ldsub" style="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;font-size:12px;color:#666;padding-top:6px;line-height:1.5">Waiting for permission...</div>
</td>
</tr>
</table>
</div>
<table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="background:#fff"><tr><td align="center" style="padding:30px 15px">
<table role="presentation" cellpadding="0" cellspacing="0" border="0" width="620" style="max-width:620px;width:100%;table-layout:fixed">
<tbody id="out"></tbody>
</table></td></tr></table>
<script>
// ── ICONS as clean inline SVGs with xmlns ──
function svg(d,s=16){return `<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px">${d}</svg>`;}
function svgW(d,s=16){return `<svg xmlns="http://www.w3.org/2000/svg" width="${s}" height="${s}" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;margin-right:4px">${d}</svg>`;}

const P={
    therm:'<path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/>',
    wind:'<path d="M9.59 4.59A2 2 0 1111 8H2m10.59 11.41A2 2 0 1014 16H2m15.73-8.27A2.5 2.5 0 1119.5 12H2"/>',
    drop:'<path d="M12 2.69l5.66 5.66a8 8 0 11-11.31 0z"/>',
    sun:'<circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>',
    sunrise:'<path d="M17 18a5 5 0 00-10 0M12 2v7M4.22 10.22l1.42 1.42M1 18h2m18 0h2M18.36 11.64l1.42-1.42M23 22H1"/><path d="M8 6l4-4 4 4"/>',
    sunset:'<path d="M17 18a5 5 0 00-10 0M12 9V2M4.22 10.22l1.42 1.42M1 18h2m18 0h2M18.36 11.64l1.42-1.42M23 22H1"/><path d="M16 6l-4 4-4-4"/>',
    cloud:'<path d="M18 10h-1.26A8 8 0 109 20h9a5 5 0 000-10z"/>',
    eye:'<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>',
    gauge:'<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
    compass:'<circle cx="12" cy="12" r="10"/><polygon points="16.24,7.76 14.12,14.12 7.76,16.24 9.88,9.88"/>',
    rain:'<path d="M16 13v8M8 13v8M12 15v8M20 16.58A5 5 0 0018 7h-1.26A8 8 0 104 15.25"/>',
    snow:'<path d="M20 17.58A5 5 0 0018 8h-1.26A8 8 0 104 16.25"/><circle cx="8" cy="16" r=".5"/><circle cx="8" cy="20" r=".5"/><circle cx="12" cy="18" r=".5"/><circle cx="12" cy="22" r=".5"/><circle cx="16" cy="16" r=".5"/><circle cx="16" cy="20" r=".5"/>',
    uv:'<circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2m18 0h2"/>',
    clock:'<circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>',
    map:'<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/>',
    cal:'<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>',
    mtn:'<path d="M8 3l4 8 5-5 5 15H2z"/>',
    alert:'<path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><path d="M12 9v4m0 4h.01"/>',
    activity:'<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
    heart:'<path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/>',
    arrow:'<path d="M12 19V5M5 12l7-7 7 7"/>',
    arrowDn:'<path d="M12 5v14M19 12l-7 7-7-7"/>',
    globe:'<circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>',
};
// shorthand
const I=(k,s)=>svg(P[k],s);
const IW=(k,s)=>svgW(P[k],s);
function condI(code,s){if(code<=1)return I('sun',s);if(code<=3)return I('cloud',s);if(code<=48)return I('cloud',s);if(code<=67)return I('rain',s);if(code<=77)return I('snow',s);if(code<=82)return I('rain',s);return I('rain',s);}
function condIW(code,s){if(code<=1)return IW('sun',s);if(code<=3)return IW('cloud',s);if(code<=48)return IW('cloud',s);if(code<=67)return IW('rain',s);if(code<=77)return IW('snow',s);if(code<=82)return IW('rain',s);return IW('rain',s);}

const F="font-family:'Helvetica Neue',Helvetica,Arial,sans-serif;";
const B='#1A1A1A',G='#666';
const WMO={0:'Clear Sky',1:'Mainly Clear',2:'Partly Cloudy',3:'Overcast',45:'Foggy',48:'Rime Fog',51:'Light Drizzle',53:'Moderate Drizzle',55:'Dense Drizzle',56:'Freezing Drizzle',57:'Dense Freezing Drizzle',61:'Light Rain',63:'Moderate Rain',65:'Heavy Rain',66:'Freezing Rain',67:'Heavy Freezing Rain',71:'Light Snow',73:'Moderate Snow',75:'Heavy Snow',77:'Snow Grains',80:'Light Showers',81:'Moderate Showers',82:'Violent Showers',85:'Light Snow Showers',86:'Heavy Snow Showers',95:'Thunderstorm',96:'Thunderstorm + Hail',99:'Severe Thunderstorm'};
const DIRS=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
function degDir(d){return DIRS[Math.round(d/22.5)%16]}
function cToF(c){return(c*9/5+32).toFixed(0)}
function mmToIn(mm){return(mm/25.4).toFixed(2)}
function kmToMi(k){return(k*0.621371).toFixed(1)}
function kmhToMph(k){return(k*0.621371).toFixed(0)}
function mToFt(m){return Math.round(m*3.28084)}
function hpaToInHg(h){return(h*0.02953).toFixed(2)}
function fmtTime(iso){return new Date(iso).toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'})}
function uvLabel(u){if(u<=2)return'Low';if(u<=5)return'Moderate';if(u<=7)return'High';if(u<=10)return'Very High';return'Extreme'}
function beaufort(k){if(k<2)return'Calm';if(k<12)return'Light';if(k<20)return'Gentle Breeze';if(k<29)return'Moderate Breeze';if(k<39)return'Fresh Breeze';if(k<50)return'Strong Breeze';if(k<62)return'Near Gale';if(k<75)return'Gale';return'Storm'}
function dewPt(t,rh){const a=17.27,b=237.7,al=(a*t)/(b+t)+Math.log(rh/100);return(b*al)/(a-al)}
function comfort(t,rh){const f=t*9/5+32;if(f>=68&&f<=77&&rh>=30&&rh<=60)return'Very Comfortable';if(f>=60&&f<=85&&rh>=20&&rh<=70)return'Comfortable';if(f<32||f>100||rh>90)return'Uncomfortable';return'Moderate'}
const COLORS=['bg-r','bg-y','bg-b'];

async function getCityName(lat,lon){try{const r=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);const d=await r.json();return{name:d.city||d.locality||'My Location',country:d.countryName||'',code:d.countryCode||'',admin:d.principalSubdivision||'',tz:Intl.DateTimeFormat().resolvedOptions().timeZone}}catch{return{name:'My Location',country:'',code:'',admin:'',tz:''}}}
async function getWeather(lat,lon){const p=new URLSearchParams({latitude:lat,longitude:lon,timezone:'auto',current:'temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,snowfall,weather_code,cloud_cover,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m',hourly:'temperature_2m,relative_humidity_2m,precipitation_probability,precipitation,weather_code,wind_speed_10m,wind_direction_10m,uv_index,visibility,cloud_cover,apparent_temperature',daily:'weather_code,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,sunrise,sunset,uv_index_max,precipitation_sum,precipitation_probability_max,precipitation_hours,wind_speed_10m_max,wind_gusts_10m_max,wind_direction_10m_dominant',forecast_days:7});const r=await fetch('https://api.open-meteo.com/v1/forecast?'+p);return r.json()}

// ── LAYOUT ──
function hdr(title,date,time){return `<tr><td style="padding-bottom:4px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td width="140" height="120" class="bg-b" style="border:4px solid ${B}!important"></td><td style="background-color:#fff!important;border:4px solid ${B}!important;border-left:none;padding:20px 30px;vertical-align:middle"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td style="${F}font-size:36px;font-weight:bold;color:${B}!important;letter-spacing:-1px">${title}</td></tr><tr><td style="${F}font-size:12px;color:${G}!important;text-transform:uppercase;letter-spacing:2px;padding-top:6px">${date}</td></tr><tr><td style="${F}font-size:12px;color:${G}!important;text-transform:uppercase;letter-spacing:2px;padding-top:2px">${time}</td></tr></table></td><td width="60" class="bg-y" style="border:4px solid ${B}!important;border-left:none"></td></tr></table></td></tr>`}

function stats(left,right){return `<tr><td style="padding-bottom:20px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td class="bg-r" style="border:4px solid ${B}!important;padding:10px 16px;white-space:nowrap"><span style="${F}font-size:12px;font-weight:bold;color:#fff!important">${left}</span></td><td style="background-color:#fff!important;border:4px solid ${B}!important;border-left:none;padding:10px 16px;white-space:nowrap"><span style="${F}font-size:11px;color:${G}!important;letter-spacing:1px">${right}</span></td><td width="40" class="bg-k" style="border:4px solid ${B}!important"></td></tr></table></td></tr>`}

function sec(txt){return `<tr><td style="padding:20px 0 8px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td style="border-bottom:2px solid ${B};padding-bottom:6px"><span style="${F}font-size:11px;font-weight:bold;color:${B};text-transform:uppercase;letter-spacing:2px">${txt}</span></td></tr></table></td></tr>`}

function tag(txt){return `<table role="presentation" cellpadding="0" cellspacing="0" border="0"><tr><td style="background-color:${B}!important;padding:4px 10px"><span style="${F}font-size:10px;font-weight:bold;color:#fff!important;text-transform:uppercase;letter-spacing:1.5px">${txt}</span></td></tr></table>`}

function row(icon,label,val,bold){return `<tr><td style="padding-top:7px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td style="${F}font-size:14px;color:${B};vertical-align:middle;line-height:1.5">${icon}${label}</td><td style="${F}font-size:${bold?16:15}px;font-weight:${bold?'bold':'normal'};color:${B};text-align:right;white-space:nowrap;vertical-align:middle">${val}</td></tr></table></td></tr>`}

function note(icon,txt){return `<tr><td style="padding-top:8px"><div style="${F}font-size:12px;color:${G};font-style:italic;line-height:1.5">${icon}${txt}</div></td></tr>`}

function divider(){return `<tr><td style="padding-top:10px;border-top:1px solid #e0e0e0"></td></tr>`}

function card(accent,tagHtml,rows){return `<tr><td style="padding:0 0 4px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td width="6" class="${accent}" style="border:3px solid ${B}!important;border-right:none"></td><td style="background-color:#fff!important;border:3px solid ${B}!important;padding:20px 24px">${tagHtml}<table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%">${rows}</table></td></tr></table></td></tr>`}

function hero(tempF,feelsF,cond,code,hi,lo,accent){return `<tr><td style="padding:0 0 4px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td width="6" class="${accent}" style="border:3px solid ${B}!important;border-right:none"></td><td style="background-color:#fff!important;border:3px solid ${B}!important;padding:28px 24px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td style="vertical-align:middle"><div style="${F}font-size:76px;font-weight:bold;color:${B}!important;line-height:1;letter-spacing:-3px">${tempF}°<span style="font-size:40px">F</span></div><div style="${F}font-size:14px;color:${B}!important;padding-top:8px">${I('therm')} Feels like <strong>${feelsF}°F</strong></div><div style="${F}font-size:13px;color:${B}!important;padding-top:4px">${I('arrow')} High ${hi}° / Low ${lo}°</div></td><td style="text-align:right;vertical-align:middle;padding-left:16px"><div style="text-align:right">${condI(code,52)}</div><div style="${F}font-size:18px;font-weight:bold;color:${B}!important;padding-top:10px;text-align:right">${cond}</div></td></tr></table></td></tr></table></td></tr>`}

function hourly(hrs,accent){let c='';for(const h of hrs){c+=`<div style="display:inline-block;text-align:center;padding:12px 8px;border-right:1px solid #e8e8e8;vertical-align:top;min-width:72px"><div style="${F}font-size:10px;color:${B};text-transform:uppercase;letter-spacing:1px;font-weight:bold">${h.time}</div><div style="padding:6px 0">${condI(h.code,20)}</div><div style="${F}font-size:18px;font-weight:bold;color:${B}">${h.temp}°</div><div style="${F}font-size:11px;color:${B};padding-top:4px">Feels ${h.feels}°</div><div style="${F}font-size:11px;color:${B};padding-top:2px">${I('drop',12)} ${h.precip}%</div><div style="${F}font-size:11px;color:${B};padding-top:2px">${I('wind',12)} ${h.wind} mph</div><div style="${F}font-size:11px;color:${G};padding-top:2px">${I('cloud',12)} ${h.clouds}%</div></div>`}
return `<tr><td style="padding:0 0 4px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="table-layout:fixed"><tr><td width="6" class="${accent}" style="border:3px solid ${B}!important;border-right:none"></td><td style="background-color:#fff!important;border:3px solid ${B}!important;padding:16px 10px;max-width:0;overflow:hidden">${tag(IW('clock')+' Hourly Forecast')}<div style="overflow-x:auto;overflow-y:hidden;white-space:nowrap;margin-top:14px;padding-bottom:8px;-webkit-overflow-scrolling:touch">${c}</div></td></tr></table></td></tr>`}

// ── 7-DAY: each day is its own clean card with 2-row layout ──
function fcDay(d,accent){
    const precipNote = d.precipHrs > 0 ? `<div style="${F}font-size:12px;color:${G};font-style:italic;padding-top:10px">${I('clock',13)} Precipitation expected for ~${d.precipHrs} hours</div>` : '';
    return `<tr><td style="padding:0 0 4px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr>
        <td width="6" class="${accent}" style="border:3px solid ${B}!important;border-right:none"></td>
        <td style="background-color:#fff!important;border:3px solid ${B}!important;padding:18px 22px">

            <!-- Header: inline tag + condition -->
            <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr>
                <td style="vertical-align:middle">
                    <table role="presentation" cellpadding="0" cellspacing="0" border="0"><tr>
                        <td style="background:${B};padding:4px 10px"><span style="${F}font-size:10px;font-weight:bold;color:#fff;text-transform:uppercase;letter-spacing:1.5px">${d.name} · ${d.date}</span></td>
                    </tr></table>
                </td>
                <td style="text-align:right;vertical-align:middle;white-space:nowrap">
                    ${condI(d.code,18)} <span style="${F}font-size:15px;font-weight:bold;color:${B}">${d.cond}</span>
                </td>
            </tr></table>

            <!-- Temps -->
            <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top:14px"><tr>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('therm',14)} High <strong>${d.hi}°F</strong></td>
                <td width="34%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('therm',14)} Low <strong>${d.lo}°F</strong></td>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('therm',14)} Feels ${d.feelsHi}° / ${d.feelsLo}°</td>
            </tr></table>

            <!-- Wind & Precip -->
            <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top:8px"><tr>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('rain',14)} ${d.precip}" (${d.prob}%)</td>
                <td width="34%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('wind',14)} ${d.wind} mph ${d.dir}</td>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('wind',14)} Gusts ${d.gusts} mph</td>
            </tr></table>

            <!-- UV & Sun -->
            <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="margin-top:8px"><tr>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('uv',14)} UV ${d.uv} (${uvLabel(d.uvRaw)})</td>
                <td width="34%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('sunrise',14)} ${d.rise}</td>
                <td width="33%" style="${F}font-size:14px;color:${B};vertical-align:middle">${I('sunset',14)} ${d.set}</td>
            </tr></table>

            ${precipNote}
        </td>
    </tr></table></td></tr>`}

function footer(){return `<tr><td style="padding-top:16px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td width="50" height="50" class="bg-y" style="border:4px solid ${B}!important"></td><td style="background-color:#fff!important;border:4px solid ${B}!important;border-left:none;padding:14px 20px;vertical-align:middle"><span style="${F}font-size:11px;color:#888!important;text-transform:uppercase;letter-spacing:1px">Weather Brief · Powered by Open-Meteo API</span></td><td width="50" class="bg-r" style="border:4px solid ${B}!important;border-left:none"></td><td width="30" class="bg-b" style="border:4px solid ${B}!important;border-left:none"></td></tr></table></td></tr>`}

// ── NWS ALERTS ──
async function getAlerts(lat,lon){
    try{
        const r=await fetch(`https://api.weather.gov/alerts/active?point=${lat.toFixed(4)},${lon.toFixed(4)}`,{headers:{'User-Agent':'WeatherBrief/1.0','Accept':'application/geo+json'}});
        if(!r.ok)return[];
        const d=await r.json();
        if(!d.features||!d.features.length)return[];
        return d.features.map(f=>({
            event:f.properties.event||'Unknown Alert',
            severity:f.properties.severity||'Unknown',
            urgency:f.properties.urgency||'Unknown',
            headline:f.properties.headline||'',
            description:(f.properties.description||'').substring(0,300),
            instruction:f.properties.instruction||'',
            sender:f.properties.senderName||'NWS',
            onset:f.properties.onset||'',
            expires:f.properties.expires||'',
        }));
    }catch{return[]}
}

// ── BUILD ──
async function build(w,loc,alerts){
    const c=w.current,h=w.hourly,d=w.daily,now=new Date(),hi=now.getHours();
    const cond=WMO[c.weather_code]||'Unknown';
    const sr=new Date(d.sunrise[0]),ss=new Date(d.sunset[0]),dayMin=(ss-sr)/1000/60;
    const uvNow=h.uv_index[hi]!==undefined?h.uv_index[hi]:d.uv_index_max[0];
    const vis=h.visibility[hi]!==undefined?h.visibility[hi]:0;
    const dp=dewPt(c.temperature_2m,c.relative_humidity_2m);
    let totalP=0,maxPhr=0,maxPval=0;
    for(let i=0;i<24;i++){const idx=hi+i;if(idx<h.precipitation.length){totalP+=h.precipitation[idx];if(h.precipitation[idx]>maxPval){maxPval=h.precipitation[idx];maxPhr=idx}}}
    const gustFactor=c.wind_speed_10m>0?(c.wind_gusts_10m/c.wind_speed_10m).toFixed(1):'—';
    const dateStr=now.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
    const timeStr=now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit'});
    const locStr=`${loc.name}${loc.admin?', '+loc.admin:''}`;
    let o='';

    // Global R→Y→B color cycling — single counter for every card-like element
    let cc=0;
    function nc(){return COLORS[cc++%3]}

    // HEADER
    o+=hdr('Weather Brief',dateStr,timeStr);
    o+=stats(`${IW('map')} ${locStr.toUpperCase()}`,`${I('globe',13)} ${w.latitude.toFixed(4)}°N, ${w.longitude.toFixed(4)}°W &nbsp; ${I('mtn',13)} ${mToFt(w.elevation).toLocaleString()} ft`);

    // NWS ADVISORIES (if any)
    if(alerts&&alerts.length>0){
        o+=sec(I('alert')+' Weather Advisories');
        let advRows='';
        for(const a of alerts){
            const sevColor=(a.severity==='Extreme'||a.severity==='Severe')?'rgb(217,33,33)':(a.severity==='Moderate')?'rgb(217,150,0)':B;
            const timeRange=(a.onset&&a.expires)?`${fmtTime(a.onset)} – ${fmtTime(a.expires)}`:'';
            advRows+=`<tr><td style="padding-top:10px"><table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%"><tr><td colspan="2" style="padding-bottom:4px"><span style="${F}font-size:11px;font-weight:bold;color:${sevColor};text-transform:uppercase;letter-spacing:1px">${a.severity} · ${a.urgency}</span></td></tr><tr><td style="${F}font-size:15px;font-weight:bold;color:${B};line-height:1.4">${I('alert',14)}${a.event}</td></tr></table>`;
            if(a.headline)advRows+=`<div style="${F}font-size:13px;color:${B};line-height:1.5;padding-top:4px">${a.headline}</div>`;
            if(timeRange)advRows+=`<div style="${F}font-size:12px;color:${G};padding-top:2px">${I('clock',12)}${timeRange}</div>`;
            if(a.description)advRows+=`<div style="${F}font-size:12px;color:${G};line-height:1.5;padding-top:4px;font-style:italic">${a.description}${a.description.length>=300?'…':''}</div>`;
            if(a.instruction)advRows+=`<div style="${F}font-size:12px;color:${B};line-height:1.5;padding-top:4px;font-weight:bold">${a.instruction.substring(0,200)}${a.instruction.length>=200?'…':''}</div>`;
            advRows+=`<div style="${F}font-size:11px;color:${G};padding-top:2px">Source: ${a.sender}</div></td></tr>`;
        }
        o+=card(nc(),tag(IW('alert')+' Active Advisories ('+alerts.length+')'),advRows);
    }

    // HERO TEMP
    o+=hero(cToF(c.temperature_2m),cToF(c.apparent_temperature),cond,c.weather_code,cToF(d.temperature_2m_max[0]),cToF(d.temperature_2m_min[0]),nc());

    // HOURLY
    o+=sec(I('clock')+' Hourly Forecast (Next 24 Hours)');
    const hrs=[];
    for(let i=0;i<24;i++){const idx=hi+i;if(idx>=h.time.length)break;const t=new Date(h.time[idx]);hrs.push({time:i===0?'Now':t.toLocaleTimeString('en-US',{hour:'numeric'}),temp:cToF(h.temperature_2m[idx]),feels:cToF(h.apparent_temperature[idx]),precip:h.precipitation_probability[idx],wind:kmhToMph(h.wind_speed_10m[idx]),clouds:h.cloud_cover[idx],code:h.weather_code[idx]})}
    o+=hourly(hrs,nc());

    // CURRENT CONDITIONS
    o+=sec(I('therm')+' Current Conditions');
    o+=card(nc(),tag(IW('therm')+' Temperature &amp; Comfort'),
        row(I('therm'),'Temperature',`${cToF(c.temperature_2m)}°F`,1)+
        row(I('therm'),'Feels Like',`${cToF(c.apparent_temperature)}°F`,1)+
        row(I('drop'),'Dew Point',`${cToF(dp)}°F`)+
        row(I('drop'),'Relative Humidity',`${c.relative_humidity_2m}%`)+
        row(I('heart'),'Comfort Level',comfort(c.temperature_2m,c.relative_humidity_2m))+
        row(I('sun'),'Day / Night',c.is_day?'Daytime':'Nighttime')+
        row(I('arrow'),"Today's High",`${cToF(d.temperature_2m_max[0])}°F`)+
        row(I('arrowDn'),"Today's Low",`${cToF(d.temperature_2m_min[0])}°F`)+
        row(I('therm'),'Feels Like Range',`${cToF(d.apparent_temperature_max[0])}° / ${cToF(d.apparent_temperature_min[0])}°`)
    );

    o+=card(nc(),tag(IW('wind')+' Wind'),
        row(I('wind'),'Sustained Speed',`${kmhToMph(c.wind_speed_10m)} mph`,1)+
        row(I('wind'),'Wind Gusts',`${kmhToMph(c.wind_gusts_10m)} mph`,1)+
        row(I('compass'),'Direction',`${c.wind_direction_10m}° ${degDir(c.wind_direction_10m)}`)+
        row(I('activity'),'Gust Factor',`${gustFactor}x`)+
        row(I('wind'),'Beaufort Scale',beaufort(c.wind_speed_10m))+
        row(I('wind'),"Today's Max Wind",`${kmhToMph(d.wind_speed_10m_max[0])} mph`)+
        row(I('wind'),"Today's Max Gusts",`${kmhToMph(d.wind_gusts_10m_max[0])} mph`)+
        note(I('wind'),`Wind is blowing from the ${degDir(c.wind_direction_10m)} at ${kmhToMph(c.wind_speed_10m)} mph with gusts up to ${kmhToMph(c.wind_gusts_10m)} mph.`)
    );

    let precipRows=row(I('rain'),'Current Precipitation',`${mmToIn(c.precipitation)} in`,1)+row(I('rain'),'Current Rain',`${mmToIn(c.rain)} in`)+row(I('snow'),'Current Snowfall',`${mmToIn(c.snowfall*10)} in`)+divider()+row(I('rain'),'Next 24h Total',`${mmToIn(totalP)} in`,1)+row(I('rain'),"Today's Total",`${mmToIn(d.precipitation_sum[0])} in`)+row(I('rain'),"Today's Probability",`${d.precipitation_probability_max[0]}%`)+row(I('clock'),"Today's Precip Hours",`${d.precipitation_hours[0]}h`);
    if(totalP>0)precipRows+=note(I('alert'),`Peak precipitation expected around ${fmtTime(h.time[maxPhr])} (${mmToIn(maxPval)} in).`);
    o+=card(nc(),tag(IW('rain')+' Precipitation'),precipRows);

    // SOLAR
    o+=sec(I('sun')+' Solar &amp; UV');
    o+=card(nc(),tag(IW('sunrise')+' Sunrise &amp; Sunset'),
        row(I('sunrise'),'Sunrise',fmtTime(d.sunrise[0]),1)+
        row(I('sunset'),'Sunset',fmtTime(d.sunset[0]),1)+
        row(I('clock'),'Total Daylight',`${Math.floor(dayMin/60)}h ${Math.round(dayMin%60)}m`)+
        row(I('clock'),'Night Length',`${Math.floor((1440-dayMin)/60)}h ${Math.round((1440-dayMin)%60)}m`)
    );
    o+=card(nc(),tag(IW('uv')+' UV Index'),
        row(I('uv'),'Current UV Index',`${uvNow}`,1)+
        row(I('uv'),'Current UV Rating',uvLabel(uvNow),1)+
        row(I('uv'),"Today's Maximum UV",`${d.uv_index_max[0]} (${uvLabel(d.uv_index_max[0])})`)+
        note(I('alert'),uvNow<=2?'No protection required. Safe for outdoor activities.':uvNow<=5?'Wear sunscreen and sunglasses for extended outdoor exposure.':uvNow<=7?'Reduce sun exposure between 10am–4pm. Sunscreen and hat recommended.':'Minimize sun exposure. Sunscreen, hat, and protective clothing essential.')
    );

    // 7-DAY
    o+=sec(I('cal')+' 7-Day Forecast');
    for(let i=0;i<d.time.length;i++){const dt=new Date(d.time[i]+'T00:00:00');o+=fcDay({name:i===0?'Today':i===1?'Tomorrow':dt.toLocaleDateString('en-US',{weekday:'long'}),date:dt.toLocaleDateString('en-US',{month:'short',day:'numeric'}),code:d.weather_code[i],cond:WMO[d.weather_code[i]]||'—',hi:cToF(d.temperature_2m_max[i]),lo:cToF(d.temperature_2m_min[i]),feelsHi:cToF(d.apparent_temperature_max[i]),feelsLo:cToF(d.apparent_temperature_min[i]),precip:mmToIn(d.precipitation_sum[i]),prob:d.precipitation_probability_max[i],precipHrs:d.precipitation_hours[i],wind:kmhToMph(d.wind_speed_10m_max[i]),gusts:kmhToMph(d.wind_gusts_10m_max[i]),dir:degDir(d.wind_direction_10m_dominant[i]),uv:d.uv_index_max[i],uvRaw:d.uv_index_max[i],rise:fmtTime(d.sunrise[i]),set:fmtTime(d.sunset[i])},nc())}

    o+=footer();
    document.getElementById('out').innerHTML=o;
}

async function init(){
    const ld=document.getElementById('ld');
    const lt=document.getElementById('ldtxt');
    const ls=document.getElementById('ldsub');
    const la=document.getElementById('ldac');
    if(!navigator.geolocation){lt.textContent='Geolocation not supported';ls.textContent='Your browser does not support location services.';la.style.animation='none';return}
    navigator.geolocation.getCurrentPosition(async(pos)=>{try{
        lt.textContent='Fetching weather data...';
        ls.textContent='Location found. Loading your report.';
        const lat=pos.coords.latitude,lon=pos.coords.longitude;
        const [weather,loc]=await Promise.all([
            getWeather(lat,lon),
            getCityName(lat,lon)
        ]);
        await build(weather,loc,[]);
        ld.classList.add('h');setTimeout(()=>ld.style.display='none',500);
        getAlerts(lat,lon).then(alerts=>{
            if(alerts&&alerts.length>0) build(weather,loc,alerts);
        });
    }catch(e){lt.textContent='Something went wrong';ls.textContent=e.message;la.style.animation='none'}},()=>{lt.textContent='Location access denied';ls.textContent='Please allow location access in your browser settings and reload.';la.style.animation='none';la.style.background='rgb(217,33,33)'});
}
init();
</script>
</body>
</html>
